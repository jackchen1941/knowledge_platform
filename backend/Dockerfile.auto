# è‡ªåŠ¨é…ç½®çš„åç«¯Dockerfile
# Auto-configured Backend Dockerfile

FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p data logs uploads

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV ENVIRONMENT=docker
ENV DATABASE_TYPE=mysql
ENV DEBUG=false

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
echo "ğŸš€ å¯åŠ¨çŸ¥è¯†ç®¡ç†å¹³å°åç«¯æœåŠ¡..."\n\
echo "Environment: $ENVIRONMENT"\n\
echo "Database Type: $DATABASE_TYPE"\n\
echo "Debug Mode: $DEBUG"\n\
\n\
# ç­‰å¾…æ•°æ®åº“å°±ç»ª\n\
echo "â³ ç­‰å¾…æ•°æ®åº“è¿æ¥..."\n\
while ! nc -z mysql 3306; do\n\
  echo "ç­‰å¾…MySQLå¯åŠ¨..."\n\
  sleep 2\n\
done\n\
echo "âœ… MySQLå·²å°±ç»ª"\n\
\n\
# ç­‰å¾…Rediså°±ç»ª\n\
echo "â³ ç­‰å¾…Redisè¿æ¥..."\n\
while ! nc -z redis 6379; do\n\
  echo "ç­‰å¾…Rediså¯åŠ¨..."\n\
  sleep 1\n\
done\n\
echo "âœ… Rediså·²å°±ç»ª"\n\
\n\
# è‡ªåŠ¨åˆå§‹åŒ–ç³»ç»Ÿ\n\
echo "ğŸ”§ è‡ªåŠ¨åˆå§‹åŒ–ç³»ç»Ÿ..."\n\
python -c "from app.core.config_auto import initialize_system; initialize_system()"\n\
\n\
# å¯åŠ¨åº”ç”¨\n\
echo "ğŸ¯ å¯åŠ¨åº”ç”¨æœåŠ¡å™¨..."\n\
exec python -m uvicorn app.main_auto:app --host 0.0.0.0 --port 8000\n\
' > /app/start.sh && chmod +x /app/start.sh

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/status || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["/app/start.sh"]